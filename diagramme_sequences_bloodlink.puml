@startuml Diagramme de SÃ©quences - BloodLink

!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxmessagesize 60
skinparam participant {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
}
skinparam actor {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
}
skinparam database {
    BackgroundColor #E8F5E8
    BorderColor #388E3C
}

title **Diagramme de SÃ©quences - Application BloodLink**\n*Plateforme de Gestion de Banques de Sang*

actor "ğŸ‘¤ Donneur" as Donor #FF9800
actor "ğŸ¥ Admin Banque" as BankAdmin #2196F3
actor "âš¡ Super Admin" as SuperAdmin #9C27B0

participant "ğŸŒ Interface Web\n(Laravel Blade)" as UI #4CAF50
participant "ğŸ” AuthController" as Auth #FF5722
participant "ğŸ“… AppointmentController" as AppointmentCtrl #3F51B5
participant "ğŸ©¸ DonationController" as DonationCtrl #E91E63
participant "ğŸ—ºï¸ BloodBankMapController" as MapCtrl #00BCD4
participant "ğŸ”” NotificationService" as NotifService #FFC107
participant "ğŸ“§ EmailService" as EmailService #795548

participant "ğŸ‘¤ User Model" as UserModel #607D8B
participant "ğŸ©º Donor Model" as DonorModel #8BC34A
participant "ğŸ“‹ Appointment Model" as AppointmentModel #FF9800
participant "ğŸ©¸ Donation Model" as DonationModel #F44336
participant "ğŸ¥ Bank Model" as BankModel #2196F3
participant "ğŸ“¦ BloodStock Model" as StockModel #9C27B0
participant "ğŸ©¸ BloodType Model" as BloodTypeModel #E91E63

database "ğŸ—„ï¸ Base de DonnÃ©es\n(MySQL)" as DB #4CAF50

== ğŸ” **Processus d'Authentification** ==

note over Donor, Auth : **Ã‰tape 1: Connexion utilisateur**
Donor -> UI: AccÃ¨s Ã  la page de connexion
UI -> Auth: showLoginForm()
Auth -> UI: Afficher formulaire de connexion
UI -> Donor: Formulaire de connexion

note over Donor, Auth : **Ã‰tape 2: Validation des identifiants**
Donor -> UI: Saisir identifiants (email/password)
UI -> Auth: login(credentials)
Auth -> UserModel: VÃ©rifier identifiants
UserModel -> DB: SELECT * FROM users WHERE email = ? AND status = 'active'
DB -> UserModel: DonnÃ©es utilisateur
UserModel -> Auth: Utilisateur authentifiÃ©

note over Auth, UI : **Ã‰tape 3: Redirection selon le rÃ´le**
Auth -> UI: Redirection vers dashboard
UI -> Donor: Dashboard donneur

== ğŸ“… **Processus de Prise de Rendez-vous** ==

note over Donor, AppointmentCtrl : **Ã‰tape 1: AccÃ¨s au formulaire**
Donor -> UI: AccÃ¨s Ã  "Prendre Rendez-vous"
UI -> AppointmentCtrl: create()
AppointmentCtrl -> BankModel: RÃ©cupÃ©rer banques actives
BankModel -> DB: SELECT * FROM banks WHERE status = 'active'
DB -> BankModel: Liste des banques
BankModel -> AppointmentCtrl: Banques disponibles
AppointmentCtrl -> UI: Formulaire de rendez-vous
UI -> Donor: Formulaire avec banques

note over Donor, AppointmentCtrl : **Ã‰tape 2: Validation et crÃ©ation**
Donor -> UI: Remplir formulaire (banque, date, heure)
UI -> AppointmentCtrl: store(appointmentData)

note over AppointmentCtrl, DonorModel : **Validation du profil donneur**
AppointmentCtrl -> DonorModel: VÃ©rifier profil donneur
DonorModel -> DB: SELECT * FROM donors WHERE user_id = ?
DB -> DonorModel: Profil donneur
DonorModel -> AppointmentCtrl: Profil trouvÃ©

note over AppointmentCtrl, BankModel : **Validation de la banque**
AppointmentCtrl -> BankModel: VÃ©rifier disponibilitÃ© banque
BankModel -> DB: SELECT * FROM banks WHERE id = ? AND status = 'active'
DB -> BankModel: DÃ©tails banque
BankModel -> AppointmentCtrl: Banque disponible

note over AppointmentCtrl, AppointmentModel : **VÃ©rification des conflits**
AppointmentCtrl -> AppointmentModel: VÃ©rifier conflit de rendez-vous
AppointmentModel -> DB: SELECT * FROM appointments WHERE donor_id = ? AND appointment_date = ?
DB -> AppointmentModel: Rendez-vous existants
AppointmentModel -> AppointmentCtrl: Aucun conflit

note over AppointmentCtrl, AppointmentModel : **CrÃ©ation du rendez-vous**
AppointmentCtrl -> AppointmentModel: create(appointmentData)
AppointmentModel -> DB: INSERT INTO appointments (donor_id, bank_id, appointment_date, status)
DB -> AppointmentModel: Rendez-vous crÃ©Ã©
AppointmentModel -> AppointmentCtrl: Rendez-vous enregistrÃ©

note over AppointmentCtrl, UI : **Confirmation**
AppointmentCtrl -> UI: Redirection avec succÃ¨s
UI -> Donor: Confirmation de crÃ©ation

== ğŸ¥ **Processus de Gestion des Rendez-vous (Admin)** ==

note over BankAdmin, AppointmentCtrl : **Ã‰tape 1: Consultation des rendez-vous**
BankAdmin -> UI: AccÃ¨s Ã  la liste des rendez-vous
UI -> AppointmentCtrl: index()
AppointmentCtrl -> BankModel: RÃ©cupÃ©rer banque de l'admin
BankModel -> DB: SELECT * FROM banks WHERE admin_id = ?
DB -> BankModel: Banque de l'admin
BankModel -> AppointmentCtrl: Banque identifiÃ©e

AppointmentCtrl -> AppointmentModel: RÃ©cupÃ©rer rendez-vous de la banque
AppointmentModel -> DB: SELECT * FROM appointments WHERE bank_id = ? ORDER BY appointment_date
DB -> AppointmentModel: Liste des rendez-vous
AppointmentModel -> AppointmentCtrl: Rendez-vous rÃ©cupÃ©rÃ©s
AppointmentCtrl -> UI: Liste des rendez-vous
UI -> BankAdmin: Interface de gestion

note over BankAdmin, AppointmentCtrl : **Ã‰tape 2: Confirmation d'un rendez-vous**
BankAdmin -> UI: Confirmer un rendez-vous
UI -> AppointmentCtrl: confirm(appointmentId)
AppointmentCtrl -> AppointmentModel: update(status = 'confirmed')
AppointmentModel -> DB: UPDATE appointments SET status = 'confirmed', confirmed_at = NOW()
DB -> AppointmentModel: Rendez-vous confirmÃ©
AppointmentModel -> AppointmentCtrl: Confirmation effectuÃ©e

note over AppointmentCtrl, NotifService : **Envoi de notification**
AppointmentCtrl -> NotifService: appointmentConfirmed(appointment)
NotifService -> DB: INSERT INTO notifications (user_id, title, message, type)
DB -> NotifService: Notification crÃ©Ã©e
NotifService -> AppointmentCtrl: Notification envoyÃ©e
AppointmentCtrl -> UI: Redirection avec succÃ¨s
UI -> BankAdmin: Confirmation de l'action

== ğŸ©¸ **Processus de Don de Sang** ==

note over BankAdmin, AppointmentCtrl : **Ã‰tape 1: Enregistrement du don**
BankAdmin -> UI: Marquer rendez-vous comme terminÃ©
UI -> AppointmentCtrl: complete(appointmentId, volume)

note over AppointmentCtrl, DonorModel : **RÃ©cupÃ©ration des donnÃ©es donneur**
AppointmentCtrl -> DonorModel: RÃ©cupÃ©rer groupe sanguin
DonorModel -> DB: SELECT blood_type_id FROM donors WHERE id = ?
DB -> DonorModel: Groupe sanguin
DonorModel -> AppointmentCtrl: Groupe sanguin rÃ©cupÃ©rÃ©

note over AppointmentCtrl, DonationModel : **CrÃ©ation du don**
AppointmentCtrl -> DonationModel: create(donationData)
DonationModel -> DB: INSERT INTO donations (appointment_id, donor_id, bank_id, blood_type_id, volume, quantity, status)
DB -> DonationModel: Don crÃ©Ã©
DonationModel -> AppointmentCtrl: Don enregistrÃ©

note over AppointmentCtrl, StockModel : **Mise Ã  jour du stock**
AppointmentCtrl -> StockModel: Mettre Ã  jour stock
StockModel -> DB: SELECT * FROM blood_stocks WHERE bank_id = ? AND blood_type_id = ?
DB -> StockModel: Stock existant
StockModel -> DB: UPDATE blood_stocks SET quantity = quantity + ?
DB -> StockModel: Stock mis Ã  jour
StockModel -> AppointmentCtrl: Stock actualisÃ©

note over AppointmentCtrl, AppointmentModel : **Finalisation du rendez-vous**
AppointmentCtrl -> AppointmentModel: update(status = 'completed')
AppointmentModel -> DB: UPDATE appointments SET status = 'completed', completed_at = NOW()
DB -> AppointmentModel: Rendez-vous terminÃ©
AppointmentModel -> AppointmentCtrl: Rendez-vous marquÃ© comme terminÃ©
AppointmentCtrl -> UI: Redirection avec succÃ¨s
UI -> BankAdmin: Confirmation de don enregistrÃ©

== ğŸ©¸ **Processus de Gestion des Dons** ==

note over BankAdmin, DonationCtrl : **Ã‰tape 1: Consultation des dons**
BankAdmin -> UI: AccÃ¨s Ã  la gestion des dons
UI -> DonationCtrl: index()
DonationCtrl -> BankModel: RÃ©cupÃ©rer banque de l'admin
BankModel -> DonationCtrl: Banque identifiÃ©e
DonationCtrl -> DonationModel: RÃ©cupÃ©rer dons de la banque
DonationModel -> DB: SELECT * FROM donations WHERE bank_id = ? ORDER BY donation_date DESC
DB -> DonationModel: Liste des dons
DonationModel -> DonationCtrl: Dons rÃ©cupÃ©rÃ©s
DonationCtrl -> UI: Liste des dons
UI -> BankAdmin: Interface de gestion des dons

note over BankAdmin, DonationCtrl : **Ã‰tape 2: Traitement d'un don**
BankAdmin -> UI: Marquer don comme traitÃ©
UI -> DonationCtrl: process(donationId)
DonationCtrl -> DonationModel: update(status = 'processed')
DonationModel -> DB: UPDATE donations SET status = 'processed', processed_at = NOW()
DB -> DonationModel: Don traitÃ©
DonationModel -> DonationCtrl: Traitement effectuÃ©

note over DonationCtrl, NotifService : **Notification de traitement**
DonationCtrl -> NotifService: donationProcessed(donation)
NotifService -> DB: INSERT INTO notifications (user_id, title, message, type)
DB -> NotifService: Notification crÃ©Ã©e
NotifService -> DonationCtrl: Notification envoyÃ©e
DonationCtrl -> UI: Redirection avec succÃ¨s
UI -> BankAdmin: Confirmation de traitement

note over BankAdmin, DonationCtrl : **Ã‰tape 3: Mise Ã  disposition**
BankAdmin -> UI: Rendre don disponible
UI -> DonationCtrl: makeAvailable(donationId)
DonationCtrl -> DonationModel: update(status = 'available')
DonationModel -> DB: UPDATE donations SET status = 'available', available_at = NOW()
DB -> DonationModel: Don disponible
DonationModel -> DonationCtrl: DisponibilitÃ© effectuÃ©e

note over DonationCtrl, NotifService : **Notification de disponibilitÃ©**
DonationCtrl -> NotifService: donationAvailable(donation)
NotifService -> DB: INSERT INTO notifications (user_id, title, message, type)
DB -> NotifService: Notification crÃ©Ã©e
NotifService -> DonationCtrl: Notification envoyÃ©e
DonationCtrl -> UI: Redirection avec succÃ¨s
UI -> BankAdmin: Confirmation de disponibilitÃ©

== ğŸ—ºï¸ **Processus de Consultation de la Carte** ==

note over Donor, MapCtrl : **Ã‰tape 1: Affichage de la carte**
Donor -> UI: AccÃ¨s Ã  la carte des banques
UI -> MapCtrl: index()
MapCtrl -> BankModel: RÃ©cupÃ©rer toutes les banques
BankModel -> DB: SELECT * FROM banks WHERE status = 'active'
DB -> BankModel: Liste des banques
BankModel -> MapCtrl: Banques rÃ©cupÃ©rÃ©es
MapCtrl -> UI: DonnÃ©es pour la carte
UI -> Donor: Carte interactive

note over Donor, MapCtrl : **Ã‰tape 2: Recherche par proximitÃ©**
Donor -> UI: Rechercher banques Ã  proximitÃ©
UI -> MapCtrl: nearby(latitude, longitude)
MapCtrl -> BankModel: Calculer distances
BankModel -> DB: SELECT *, ST_Distance_Sphere(point(longitude, latitude), point(?, ?)) as distance FROM banks WHERE status = 'active'
DB -> BankModel: Toutes les banques avec distances
BankModel -> MapCtrl: Banques avec distances
MapCtrl -> UI: Banques triÃ©es par proximitÃ©
UI -> Donor: RÃ©sultats de recherche

note over Donor, MapCtrl : **Ã‰tape 3: Filtrage par groupe sanguin**
Donor -> UI: Filtrer par groupe sanguin
UI -> MapCtrl: filterByBloodType(bloodTypeId)
MapCtrl -> StockModel: RÃ©cupÃ©rer stocks par groupe sanguin
StockModel -> DB: SELECT * FROM blood_stocks WHERE blood_type_id = ? AND quantity > 0
DB -> StockModel: Stocks du groupe sanguin
StockModel -> MapCtrl: Stocks rÃ©cupÃ©rÃ©s
MapCtrl -> BankModel: RÃ©cupÃ©rer banques avec stock
BankModel -> DB: SELECT * FROM banks WHERE id IN (SELECT bank_id FROM blood_stocks WHERE blood_type_id = ? AND quantity > 0)
DB -> BankModel: Banques avec stock
BankModel -> MapCtrl: Banques filtrÃ©es
MapCtrl -> UI: Banques avec disponibilitÃ©
UI -> Donor: RÃ©sultats filtrÃ©s

== ğŸ‘¤ **Processus de Consultation du Profil Donneur** ==

note over Donor, DonorModel : **Ã‰tape 1: AccÃ¨s au profil**
Donor -> UI: AccÃ¨s au profil
UI -> DonorCtrl: profile()
DonorCtrl -> DonorModel: RÃ©cupÃ©rer profil complet
DonorModel -> DB: SELECT * FROM donors WHERE user_id = ?
DB -> DonorModel: Profil donneur
DonorModel -> DonorCtrl: Profil rÃ©cupÃ©rÃ©
DonorCtrl -> UI: DonnÃ©es du profil
UI -> Donor: Page de profil

note over Donor, DonationCtrl : **Ã‰tape 2: Historique des dons**
Donor -> UI: Consulter historique des dons
UI -> DonationCtrl: index()
DonationCtrl -> DonorModel: RÃ©cupÃ©rer dons du donneur
DonorModel -> DB: SELECT * FROM donations WHERE donor_id = ? ORDER BY donation_date DESC
DB -> DonorModel: Historique des dons
DonorModel -> DonationCtrl: Dons rÃ©cupÃ©rÃ©s
DonationCtrl -> UI: Liste des dons
UI -> Donor: Historique des dons

== ğŸ”” **Processus de Gestion des Notifications** ==

note over Donor, NotifService : **Ã‰tape 1: Consultation des notifications**
Donor -> UI: Consulter notifications
UI -> NotificationCtrl: index()
NotificationCtrl -> UserModel: RÃ©cupÃ©rer notifications utilisateur
UserModel -> DB: SELECT * FROM notifications WHERE user_id = ? ORDER BY created_at DESC
DB -> UserModel: Notifications
UserModel -> NotificationCtrl: Notifications rÃ©cupÃ©rÃ©es
NotificationCtrl -> UI: Liste des notifications
UI -> Donor: Interface des notifications

note over Donor, NotificationCtrl : **Ã‰tape 2: Marquage comme lue**
Donor -> UI: Marquer notification comme lue
UI -> NotificationCtrl: markAsRead(notificationId)
NotificationCtrl -> DB: UPDATE notifications SET read_at = NOW() WHERE id = ?
DB -> NotificationCtrl: Notification marquÃ©e comme lue
NotificationCtrl -> UI: Confirmation
UI -> Donor: Notification mise Ã  jour

== ğŸ“Š **Processus de Rapports (Super Admin)** ==

note over SuperAdmin, ReportCtrl : **Ã‰tape 1: GÃ©nÃ©ration de rapports**
SuperAdmin -> UI: AccÃ¨s aux rapports
UI -> ReportCtrl: index()
ReportCtrl -> DonationModel: Statistiques globales
DonationModel -> DB: SELECT COUNT(*), SUM(volume) FROM donations
DB -> DonationModel: Statistiques dons
ReportCtrl -> BankModel: Statistiques banques
BankModel -> DB: SELECT COUNT(*) FROM banks WHERE status = 'active'
DB -> BankModel: Statistiques banques
ReportCtrl -> UI: DonnÃ©es des rapports
UI -> SuperAdmin: Interface des rapports

note over SuperAdmin, ReportCtrl : **Ã‰tape 2: Export des donnÃ©es**
SuperAdmin -> UI: Exporter rapport
UI -> ReportCtrl: export(format)
ReportCtrl -> DonationModel: RÃ©cupÃ©rer donnÃ©es
DonationModel -> DB: SELECT * FROM donations WHERE created_at >= ?
DB -> DonationModel: DonnÃ©es pour export
ReportCtrl -> UI: Fichier d'export
UI -> SuperAdmin: TÃ©lÃ©chargement du rapport

@enduml
